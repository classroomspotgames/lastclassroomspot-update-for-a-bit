<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassroomSpot</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#000;color:white}
.nav{padding:20px;background:#111;display:flex;align-items:center}
.logo{font-size:24px;font-weight:bold;color:#e50914}
.topbar{padding:15px 30px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #222}
#search{padding:8px 15px;border-radius:20px;border:none;background:#222;color:white;width:200px}
.games-grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
 gap:30px;
 padding:30px;
}
.game-card{
 width:120px;
 height:120px;
 border-radius:50%;
 background-size:cover;
 background-position:center;
 display:flex;
 align-items:flex-end;
 justify-content:center;
 cursor:pointer;
 transition:transform .15s ease, box-shadow .15s ease;
 box-shadow:0 0 15px rgba(0,0,0,.6);
}
.game-card:hover{transform:scale(1.08)}
.game-name{
 background:rgba(0,0,0,.6);
 width:100%;
 text-align:center;
 font-size:13px;
 padding:6px 0;
 border-radius:0 0 50% 50%;
}
.close-btn{position:fixed;top:10px;right:10px;z-index:9999;background:#e50914;color:white;border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-family:Arial,sans-serif;}

/* Preview Overlay Styles */
.preview-overlay{
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:#000;
    z-index:10000;
    flex-direction:column;
}
.preview-overlay.active{display:flex}
.preview-header{
    background:#111;
    padding:15px 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid #222;
    height:50px;
    box-sizing:border-box;
}
.preview-title{font-size:18px;font-weight:bold;color:#e50914}
.preview-close{
    background:#e50914;
    color:white;
    border:none;
    border-radius:50%;
    width:35px;
    height:35px;
    font-size:18px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
}
.preview-content{
    flex:1;
    position:relative;
    width:100%;
    height:calc(100% - 50px);
    overflow:hidden;
}
.preview-frame{
    width:100%;
    height:100%;
    border:none;
    background:#000;
}
.preview-loader{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    color:#e50914;
    font-size:24px;
    display:none;
}
</style>
</head>
<body>

<button onclick="closeWindow()" class="close-btn">✕</button>

<!-- Preview Overlay -->
<div id="previewOverlay" class="preview-overlay">
    <div class="preview-header">
        <span class="preview-title" id="previewTitle">Game Preview</span>
        <button class="preview-close" onclick="closePreview()">✕</button>
    </div>
    <div class="preview-content">
        <div class="preview-loader" id="previewLoader">Loading...</div>
        <iframe id="previewFrame" class="preview-frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-fullscreen"></iframe>
    </div>
</div>

<nav class="nav">
  <span class="logo">ClassroomSpot</span>
</nav>

<div class="topbar">
  <span id="total">Total games: loading…</span>
  <input id="search" placeholder="Search games…">
</div>

<div id="games" class="games-grid"></div>

<script>
const gamesEl = document.getElementById("games");
const search = document.getElementById("search");
const totalEl = document.getElementById("total");
const previewOverlay = document.getElementById("previewOverlay");
const previewFrame = document.getElementById("previewFrame");
const previewTitle = document.getElementById("previewTitle");
const previewLoader = document.getElementById("previewLoader");

const ZONES = "https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json";
const COVER = "https://cdn.jsdelivr.net/gh/gn-math/covers@main/";
const HTML = "https://cdn.jsdelivr.net/gh/gn-math/html@main/";

let games = [];
const ROBLOX_IMAGE = "https://tse3.mm.bing.net/th/id/OIP.Suu0wkaP6duvpXY_gWJucgAAAA?rs=1&pid=ImgDetMain&o=7&rm=3";
const GTA_IMAGE = "https://tse2.mm.bing.net/th/id/OIP.T6kQS4BQ4CCT6jlXGtAuDgHaE7?rs=1&pid=ImgDetMain&o=7&rm=3";

// Safe window handling
const isInIframe = window !== window.parent;
const safeOpenWindow = (url, title) => {
    if (isInIframe && typeof parent.openWindow === 'function') {
        parent.openWindow(url, title);
    } else {
        window.open(url, '_blank');
    }
};

const closeWindow = () => {
    if (isInIframe && typeof parent.closeWindow === 'function') {
        parent.closeWindow();
    } else {
        window.close();
    }
};

// Preview functions
function openPreview(htmlContent, title) {
    previewTitle.textContent = title || "Game Preview";
    previewOverlay.classList.add('active');
    previewLoader.style.display = 'block';
    previewFrame.style.opacity = '0';
    
    // Write the HTML content directly to the iframe
    previewFrame.srcdoc = htmlContent;
    
    previewFrame.onload = function() {
        previewLoader.style.display = 'none';
        previewFrame.style.opacity = '1';
    };
    
    // Fallback if onload doesn't fire
    setTimeout(() => {
        previewLoader.style.display = 'none';
        previewFrame.style.opacity = '1';
    }, 1000);
}

function closePreview() {
    previewOverlay.classList.remove('active');
    previewFrame.srcdoc = '';
}

// Close on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && previewOverlay.classList.contains('active')) {
        closePreview();
    }
});

// Roblox HTML content embedded directly
const ROBLOX_HTML = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>roblox - Truffled</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
}
iframe {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    border: none;
}
#truffled-logo {
    position: fixed;
    bottom: 10px;
    right: 10px;
    width: 150px;
    height: 150px;
    cursor: pointer;
    z-index: 9999;
}
</style>
</head>
<body>
<iframe src="https://nevertraveling.thepresenttraveller.com/gamefile/nowgg/roblox.html?prefix=149" allowfullscreen></iframe>
<a href="https://nevertraveling.thepresenttraveller.com" target="_blank">
    <img id="truffled-logo" src="https://nevertraveling.thepresenttraveller.com/png/logo.png" alt="Logo">
</a>
</body>
</html>`;

function addRoblox(){
    const card = document.createElement("div");
    card.className = "game-card";
    card.style.backgroundImage = "url(" + ROBLOX_IMAGE + ")";
    const label = document.createElement("div");
    label.className = "game-name";
    label.textContent = "Roblox";
    card.appendChild(label);
    // Opens embedded HTML in preview
    card.onclick = () => openPreview(ROBLOX_HTML, "Roblox");
    gamesEl.appendChild(card);
}

function addGTAViceCity(){
    const card = document.createElement("div");
    card.className = "game-card";
    card.style.backgroundImage = "url(" + GTA_IMAGE + ")";
    const label = document.createElement("div");
    label.className = "game-name";
    label.textContent = "GTA Vice City";
    card.appendChild(label);
    
    card.onclick = () => {
        window.open("https://sites.google.com/view/gtavicecityforclassroomspot/sdds?authuser=1", "_blank");
    };
    gamesEl.appendChild(card);
}

fetch(ZONES + "?t=" + Date.now())
    .then(r => r.ok ? r.json() : Promise.reject('Network error'))
    .then(data => {
        games = data.filter(g => !g.name.toLowerCase().includes("suggest"));
        totalEl.textContent = "Total games: " + (games.length + 2);
        render(games);
    })
    .catch(err => {
        console.error('Error:', err);
        totalEl.textContent = "Total games: 2 (offline)";
        gamesEl.innerHTML = "";
        addRoblox();
        addGTAViceCity();
    });

function render(list){
    gamesEl.innerHTML = "";
    addRoblox();
    addGTAViceCity();
    list.forEach(g => {
        const card = document.createElement("div");
        card.className = "game-card";
        const coverUrl = g.cover ? g.cover.replace("{COVER_URL}", COVER).replace("{HTML_URL}", HTML) : '';
        card.style.backgroundImage = "url(" + coverUrl + ")";
        const label = document.createElement("div");
        label.className = "game-name";
        label.textContent = g.name;
        card.appendChild(label);
        card.onclick = () => openGame(g);
        gamesEl.appendChild(card);
    });
}

search.oninput = () => {
    const q = search.value.toLowerCase();
    render(games.filter(g => g.name.toLowerCase().includes(q)));
};

function openGame(g){
    const win = window.open("about:blank", "_blank");
    fetch(g.url.replace("{HTML_URL}", HTML))
        .then(r => r.text())
        .then(t => {
            win.document.open();
            win.document.write(t);
            win.document.close();
        })
        .catch(err => win.document.write('<h1>Error loading game</h1>'));
}
</script>

</body>
</html>
